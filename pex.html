$def with(pex_d)

$var title: $_(u'SIP PEX Plugin')
$var page: pex

<script>

    // Initialize behaviors
    jQuery(document).ready(function(){

        jQuery("#cSubmit").click(function() {     	
        	jQuery("#clic").submit();
        });
        jQuery("button#cCancel").click(function(){
            window.location= "/";
        });
        jQuery("#cSubmitt").click(function() {     	
        	jQuery("#clict").submit();
        });
        jQuery("#cSubmitscan").click(function() {     	
        	jQuery("#clicscan").submit();
        });
        jQuery("button#docButton").click(function(){
            window.open("https://gitlab.com/seventer/pcf857x_plugin_sip/-/blob/main/doc/pcf857x-doc.md", "_blank");
        });
    });
</script>

<style>.columnName { text-align: center; }</style>
<style>.collapsetable { border-collapse: collapse; border: 3px solid blue; }</style>

<div id="plugin">
<!--     <div class="title">Command Line Control -->
<!--     <button class="execute" id="docButton" type="button" >$_('Help')</button> -->
<!--     </div> -->
    <div>
    <div class="title">$_(u'PEX -- Port Extender for SIP Irrigation Controller.')
    <button class="execute" id="docButton" type="button">$_(u'Help')</button></div>
    
    $if u"warnmsg" in pex_d:
        $if len(pex_d['warnmsg'])>0:
            <p><h2>$pex_d['warnmsg']</h2></p>
    
    <br>
    <p>PEX allows up to 128 stations to be controlled by the SIP irrigation controller.</p>
    <p>Supported hardwre: pcf8574 (8 ports), pc8575 (16 ports), mcp2308 (8 ports), mcp23017 (16 ports).</p>
    <p> The maximum number of devices (any combination) cannot exceed eight.</p>
    <p>See help page for supported options or ask for support on the SIP forum.</p>
    <br>
    </div>

</script>
<div id="stations">
    <div class="title">$_(u'Settings')</div>
    <form id="clic" name="clic" action="/pexu" method="get">
        
        <table id="optionList">
            <tr>
                <td style='text-transform: none;'>$_(u'SMBus id:')</td> 
                <td><input type="number" min="0" max="1" name="bus" value="${pex_d['bus']}"> (usually 1)</td>
            </tr>
            <tr><td colspan="2"><hr></td></tr>
            <tr>
                <td style='text-transform: none;'>$_(u'IC Type: '):</td>
                <td><input type="radio" id="pcf8574" name="ictype" value="pcf8574" ${"checked" if pex_d['ictype' ] =="pcf8574"  else ""}>
                    <label for="pcf8574">pcf8574 (8bit)</label></td>
                    <td><input type="radio" id="pcf8575" name="ictype" value="pcf8575" ${"checked" if pex_d['ictype' ] =="pcf8575"  else ""}>
                        <label for="pcf8575">pcf8575 (16bit)  ---->  Future use, this setting is ignored for now.</label></td>
            </tr>
        </table>
        <hr>
        <table>
            <tr>
                <th class="stationNumber">$_(u'Board')</th>
                <th class="columnName">$_(u'0xAdr')</th>
            </tr>
            $for bid in range(0,gv.sd['nbrd']):
                    <tr>
                        <td class="BoardID">${bid + 1}</td>
                        <td class="command">                         
                            <input type="text" size="10" value="${pex_d['adr'][bid] if bid < len(pex_d['adr']) else ''}" id="con${bid}" name="con${bid}">
                        </td>                       
                    </tr>
        </table>
        
            $for bid in range(gv.sd['nbrd']):
            	<input type="hidden" id="i${bid}" name="i${bid}"/>
        
        <input type="checkbox" name="debug" id="debug" ${"checked" if pex_d['debug' ] =="1" else ""}>
        <label for="debug">log extended information</label>
        
    </form>
            <p></p>
</div>
<div class="controls">
    <button id="cSubmit" class="submit"><b>$_(u'Submit')</b></button>
    <button id="cCancel" class="cancel danger">$_(u'Cancel')</button>
</div>

<br><hr>

<div id="tools">
    <div class="title">$_(u'Search for devices')</div>
    
    <div class="controls">
        <button id="cSubmitscan" class="submitscan"><b>$_(u'Scan devices')</b></button>
    </div>
    
    <form id="clicscan" name="clicscan" action="/pex_scan" method="GET">
        
        $if len(pex_d['devices'])>0:
            <h4>$_(u'Devices found')</h4>
            <table style= "border: 1px solid black" id=deviceresults>
                $for i in pex_d['devices']:
                    <tr>
                        <td style= "border: 1px solid black">${hex(i)}</td>
                    </tr>
            </table>
        $else:
            <input type="hidden" id="scanme" name="scanme" value="true"/>
    </form>
    <br>
    <div class="title">$_(u'Advanced (i2c) tools')</div> see helppage
    <form id="clict" name="clict" action="/pext" method="POST">
        <table id="smbusCommand">
            <tr>
                <td>smbus</td>
                <td>0xadr</td>
                <td>0xdata</td>
            </tr>
            <tr>
                <td>
                    <input type="text" size="2" value="1" name="tst_smbus">
                </td>
                <td>
                    <input type="text" size="4" value="${pex_d['adr'][0]}" name="tst_adres">
                </td>
                <td>
                    <input type="text" size="4" value="0x08" name="tst_value">
                </td>
                <td>0x00 = all On  0xFF = all off</td>
            </tr>

        </table>
    </form>
</div>

<div class="controls">
    <button id="cSubmitt" class="submitt"><b>$_(u'Set')</b></button>
</div>

<p>
</p>

<p></p>

</div>
